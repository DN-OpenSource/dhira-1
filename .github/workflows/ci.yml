name: ci

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: sbt

      - name: Install Verilator + GTKWave
        run: |
          sudo apt-get update -y
          sudo apt-get install -y verilator gtkwave

      - name: Install sbt
        run: |
          sudo apt-get install -y curl gnupg ca-certificates
          echo "deb https://repo.scala-sbt.org/scalasbt/debian all main" | sudo tee /etc/apt/sources.list.d/sbt.list
          echo "deb https://repo.scala-sbt.org/scalasbt/debian /" | sudo tee -a /etc/apt/sources.list.d/sbt.list
          curl -fsSL https://keyserver.ubuntu.com/pks/lookup?op=get\&search=0x2EE0EA64E40A89B84B2DF73499E82A75642AC823 | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/sbt.gpg
          sudo apt-get update -y
          sudo apt-get install -y sbt

      - name: Run Scala tests (Verilator + VCD)
        run: |
          sbt -no-colors test

      - name: Upload waveforms (best-effort)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vcd
          path: |
            target/test_run_dir
          if-no-files-found: ignore
